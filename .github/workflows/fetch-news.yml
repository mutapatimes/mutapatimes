name: Fetch GNews Data

# Runs every 2 hours (6 categories x 12 runs = 72 requests/day, within GNews free tier of 100/day)
on:
  schedule:
    - cron: '0 */2 * * *'
  workflow_dispatch:

jobs:
  fetch-news:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Fetch news data from GNews
        env:
          GNEWS_API_KEY: ${{ secrets.GNEWS_API_KEY }}
        run: |
          mkdir -p data

          fetch_category() {
            local category="$1"
            local query="$2"
            local url="https://gnews.io/api/v4/search?q=${query}&token=${GNEWS_API_KEY}&lang=en&max=10"
            local tmp
            tmp=$(mktemp)

            if curl -sf "$url" -o "$tmp"; then
              if python3 -c "import sys,json; d=json.load(sys.stdin); assert len(d.get('articles',[])) > 0" < "$tmp"; then
                mv "$tmp" "data/${category}.json"
                echo "OK: ${category}"
              else
                rm -f "$tmp"
                echo "SKIP: ${category} (no articles or API error, keeping existing data)"
              fi
            else
              rm -f "$tmp"
              echo "FAIL: ${category} (network error, keeping existing data)"
            fi
          }

          fetch_category "home" "Zimbabwe+business+economy"
          sleep 2
          fetch_category "business" "Zimbabwe+business+economy"
          sleep 2
          fetch_category "politics" "Zimbabwe+politics+government"
          sleep 2
          fetch_category "health" "Zimbabwe+health"
          sleep 2
          fetch_category "arts" "Zimbabwe+arts+culture+music"
          sleep 2
          fetch_category "sport" "Zimbabwe+sport+cricket+football+rugby"

      - name: Commit and push updated data
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/
          git diff --cached --quiet || (git commit -m "Update news data [automated]" && git push)
