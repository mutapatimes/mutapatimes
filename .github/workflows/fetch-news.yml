name: Fetch News Data

# Runs every 3 hours â€” 6 categories via GNews search endpoint
on:
  schedule:
    - cron: '0 */3 * * *'
  workflow_dispatch:

jobs:
  fetch-news:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Fetch news data from GNews
        env:
          GNEWS_API_KEY: ${{ secrets.GNEWS_API_KEY }}
        run: |
          mkdir -p data

          # Strategy: try top-headlines first (best quality), fall back to search endpoint
          # No country filter = global English-language sources (Reuters, BBC, CNN, etc.)

          fetch_headlines() {
            local category="$1"
            local topic="$2"
            local url="https://gnews.io/api/v4/top-headlines?topic=${topic}&apikey=${GNEWS_API_KEY}&lang=en&max=10&nullable=image"
            local tmp
            tmp=$(mktemp)

            echo "Trying top-headlines topic=${topic} for ${category}..."
            if curl -sf "$url" -o "$tmp"; then
              if python3 -c "import sys,json; d=json.load(sys.stdin); assert len(d.get('articles',[])) > 0" < "$tmp"; then
                mv "$tmp" "data/${category}.json"
                echo "  OK: ${category} (top-headlines)"
                return 0
              fi
              rm -f "$tmp"
            else
              rm -f "$tmp"
            fi
            return 1
          }

          fetch_search() {
            local category="$1"
            local query="$2"
            local url="https://gnews.io/api/v4/search?q=${query}&apikey=${GNEWS_API_KEY}&lang=en&max=10&sortby=publishedAt&nullable=image"
            local tmp
            tmp=$(mktemp)

            echo "Trying search q=${query} for ${category}..."
            if curl -sf "$url" -o "$tmp"; then
              if python3 -c "import sys,json; d=json.load(sys.stdin); assert len(d.get('articles',[])) > 0" < "$tmp"; then
                mv "$tmp" "data/${category}.json"
                echo "  OK: ${category} (search)"
                return 0
              fi
              rm -f "$tmp"
            else
              rm -f "$tmp"
            fi
            echo "  FAIL: ${category}"
            return 1
          }

          fetch_category() {
            local category="$1"
            local topic="$2"
            local search_query="$3"

            # Try top-headlines first
            if fetch_headlines "$category" "$topic"; then
              return 0
            fi

            # Fallback to search
            fetch_search "$category" "$search_query"
          }

          fetch_category "business" "business" "business OR economy OR finance OR markets"
          sleep 2
          fetch_category "technology" "technology" "technology OR AI OR software OR startups"
          sleep 2
          fetch_category "entertainment" "entertainment" "entertainment OR movies OR music OR celebrity"
          sleep 2
          fetch_category "sports" "sports" "sports OR football OR basketball OR tennis"
          sleep 2
          fetch_category "science" "science" "science OR research OR space OR climate"
          sleep 2
          fetch_category "health" "health" "health OR medical OR disease OR WHO"

      - name: Commit and push updated data
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/
          git diff --cached --quiet || (git commit -m "Update news data [automated]" && git push)
