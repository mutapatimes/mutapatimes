name: Fetch News Data

# Runs every 3 hours â€” 6 categories via GNews only
on:
  schedule:
    - cron: '0 */3 * * *'
  workflow_dispatch:

jobs:
  fetch-news:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Fetch news data from GNews
        env:
          GNEWS_API_KEY: ${{ secrets.GNEWS_API_KEY }}
        run: |
          mkdir -p data

          fetch_gnews() {
            local category="$1"
            local topic="$2"
            local url="https://gnews.io/api/v4/top-headlines?topic=${topic}&token=${GNEWS_API_KEY}&lang=en&country=zw&max=10"
            local tmp
            tmp=$(mktemp)

            echo "Fetching GNews topic=${topic} for ${category}..."
            if curl -sf "$url" -o "$tmp"; then
              if python3 -c "import sys,json; d=json.load(sys.stdin); assert len(d.get('articles',[])) > 0" < "$tmp"; then
                mv "$tmp" "data/${category}.json"
                echo "  OK: ${category}"
                return 0
              fi
              rm -f "$tmp"
            else
              rm -f "$tmp"
            fi
            echo "  FAIL: ${category}"
            return 1
          }

          fetch_gnews "business" "business"
          sleep 2
          fetch_gnews "technology" "technology"
          sleep 2
          fetch_gnews "entertainment" "entertainment"
          sleep 2
          fetch_gnews "sports" "sports"
          sleep 2
          fetch_gnews "science" "science"
          sleep 2
          fetch_gnews "health" "health"

      - name: Commit and push updated data
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/
          git diff --cached --quiet || (git commit -m "Update news data [automated]" && git push)
